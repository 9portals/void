<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Void</title>
  <style>
    body {
      margin: 0;
      font-family: 'Courier New', monospace;
      background-color: #000;
      color: #ccc;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 10px;
    }
    #void, #vault {
      width: 100%;
      max-width: 600px;
      margin-top: 20px;
    }
    #messages, #vaultMessages {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    .message, .vault-message {
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 5px;
      position: relative;
    }
    .timer {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 12px;
      color: #888;
    }
    #inputForm {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    input, button {
      padding: 10px;
      background: #111;
      color: #ccc;
      border: 1px solid #333;
      border-radius: 5px;
    }
    button:hover {
      background: #222;
      cursor: pointer;
    }
    #authSection {
      margin-top: 10px;
    }
    #vaultToggle {
      margin-top: 20px;
      cursor: pointer;
      color: #aaa;
      font-size: 14px;
    }
    #vault {
      display: none;
    }
  </style>
</head>
<body>

<h1>Welcome to the Void</h1>

<div id="authSection">
  <button id="loginBtn">Login / Register</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
</div>

<div id="void">
  <form id="inputForm">
    <input type="text" id="messageInput" placeholder="Speak into the void..." required>
    <button type="submit">Send</button>
  </form>
  <div id="messages"></div>
</div>

<div id="vaultToggle">[+] Open Vault</div>
<div id="vault">
  <h2>Your Vault</h2>
  <div id="vaultMessages"></div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  // Your Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyD1YgjFsxh-xZfeHlrxt_0igmH6SBIMcuc",
    authDomain: "void-d9ec4.firebaseapp.com",
    projectId: "void-d9ec4",
    storageBucket: "void-d9ec4.appspot.com",
    messagingSenderId: "267268035851",
    appId: "1:267268035851:web:d535fe4175c06f170f3e0e",
    measurementId: "G-78DGNW8HV3"
  };

  // Initialize
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const messagesRef = collection(db, "voidMessages");
  const vaultRef = collection(db, "vault");

  const messagesDiv = document.getElementById('messages');
  const vaultDiv = document.getElementById('vaultMessages');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const vaultToggle = document.getElementById('vaultToggle');
  const vaultSection = document.getElementById('vault');

  let currentUser = null;

  // Send Message to Void
  document.getElementById('inputForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = document.getElementById('messageInput').value.trim();
    if (text) {
      await addDoc(messagesRef, {
        text,
        created: serverTimestamp()
      });
      document.getElementById('messageInput').value = '';
    }
  });

  // Display Messages with countdown
  onSnapshot(query(messagesRef, orderBy('created')), (snapshot) => {
    messagesDiv.innerHTML = '';
    const now = Date.now();
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      if (!data.created) return;
      const elapsed = (now - data.created.toMillis()) / 1000;
      const remaining = 60 - elapsed;
      if (remaining > 0) {
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `
          ${data.text}
          <div class="timer">${Math.floor(remaining)}s</div>
          ${currentUser ? `<button onclick="saveToVault('${docSnap.id}', '${encodeURIComponent(data.text)}')">Save</button>` : ''}
        `;
        messagesDiv.appendChild(div);

        setTimeout(async () => {
          if (docSnap.ref) {
            try { await deleteDoc(docSnap.ref); } catch (e) {}
          }
        }, remaining * 1000);
      }
    });
  });

  // Save to Vault
  window.saveToVault = async (id, text) => {
    if (!currentUser) return;
    const q = query(vaultRef, where('userId', '==', currentUser.uid), where('text', '==', decodeURIComponent(text)));
    const snap = await getDocs(q);
    if (snap.empty) {
      await addDoc(vaultRef, {
        userId: currentUser.uid,
        text: decodeURIComponent(text),
        saved: serverTimestamp()
      });
    }
  };

  // Load Vault
  function loadVault() {
    if (!currentUser) return;
    onSnapshot(query(vaultRef, where('userId', '==', currentUser.uid), orderBy('saved')), (snapshot) => {
      vaultDiv.innerHTML = '';
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement('div');
        div.className = 'vault-message';
        div.innerHTML = `
          ${data.text}
          <button onclick="deleteVaultMessage('${docSnap.id}')">Delete</button>
        `;
        vaultDiv.appendChild(div);
      });
    });
  }

  // Delete Vault Message
  window.deleteVaultMessage = async (id) => {
    await deleteDoc(doc(db, "vault", id));
  };

  // Auth
  loginBtn.addEventListener('click', async () => {
    const email = prompt("Enter Email:");
    const password = prompt("Enter Password:");
    if (email && password) {
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        await createUserWithEmailAndPassword(auth, email, password);
      }
    }
  });

  logoutBtn.addEventListener('click', () => {
    signOut(auth);
  });

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (user) {
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
      loadVault();
    } else {
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
      vaultDiv.innerHTML = '';
    }
  });

  // Toggle Vault
  vaultToggle.addEventListener('click', () => {
    if (vaultSection.style.display === 'none') {
      vaultSection.style.display = 'block';
      vaultToggle.textContent = "[-] Close Vault";
    } else {
      vaultSection.style.display = 'none';
      vaultToggle.textContent = "[+] Open Vault";
    }
  });
</script>

</body>
</html>
