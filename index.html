<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>The Void</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #000;
      color: #ccc;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    h1 {
      margin-bottom: 20px;
    }
    #inputForm {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      background: #111;
      color: #ccc;
      border: 1px solid #333;
      border-radius: 5px;
    }
    button:hover {
      background: #222;
      cursor: pointer;
    }
    #messages {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      max-width: 600px;
    }
    .message {
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 5px;
      position: relative;
    }
    .timer {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 12px;
      color: #888;
    }
    .auto-message {
      cursor: pointer;
    }
    .moon-icon {
      position: absolute;
      bottom: 5px;
      right: 10px;
      font-size: 18px;
      cursor: pointer;
      color: #888;
    }
    .replies {
      margin-top: 10px;
      padding-left: 15px;
      border-left: 1px solid #444;
      display: none;
      flex-direction: column;
      gap: 5px;
    }
    .reply {
      font-size: 14px;
      background: rgba(255, 255, 255, 0.08);
      padding: 5px;
      border-radius: 4px;
    }
    .expand-button {
      margin-top: 5px;
      background: #222;
      border: none;
      color: #aaa;
      padding: 5px;
      cursor: pointer;
      font-size: 12px;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<h1>Welcome to the Void</h1>

<form id="inputForm">
  <input type="text" id="messageInput" placeholder="Speak into the void..." required>
  <button type="submit">Send</button>
</form>

<div id="harvestResults">
  <p>Void Energy: <span id="voidEnergy">0</span></p>
  <p>Void Light: <span id="voidLight">0</span></p>
  <p>Void Fractals: <span id="voidFractals">0</span></p>
</div>

<div id="messages"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD1YgjFsxh-xZfeHlrxt_0igmH6SBIMcuc",
    authDomain: "void-d9ec4.firebaseapp.com",
    projectId: "void-d9ec4",
    storageBucket: "void-d9ec4.appspot.com",
    messagingSenderId: "267268035851",
    appId: "1:267268035851:web:d535fe4175c06f170f3e0e",
    measurementId: "G-78DGNW8HV3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const messagesRef = collection(db, "voidMessages");
  const messagesDiv = document.getElementById('messages');

  let voidEnergy = 0;
  let voidLight = 0;
  let voidFractals = 0;

  const liveTimers = {};
  let currentMessages = [];

  const autoMessages = [
    "The void whispers your name.",
    "A shadow passes through the silence.",
    "A faint heartbeat echoes.",
    "An unseen star collapses.",
    "The fabric of space trembles.",
    "Time flickers and stalls.",
    "Infinity curls inward.",
    "Something watches from beyond.",
    "Light bends unnaturally.",
    "Fragments of lost dreams swirl.",
    "The horizon bleeds darkness.",
    "Silent footsteps approach.",
    "Reality fractures at its edges.",
    "An ancient call resonates.",
    "Ghosts of thought drift by.",
    "A ripple disturbs the stillness.",
    "Hope glimmers faintly.",
    "The void stretches endlessly.",
    "Silent thunder roars.",
    "A crack splits existence.",
    "An echo of laughter fades.",
    "A shiver runs through the stars.",
    "Entropy deepens the dark.",
    "A murmur stirs the dust.",
    "A memory surfaces, then sinks.",
    "Eyes blink in forgotten skies.",
    "Ash rains upon barren fields.",
    "Nebulas pulse with dying light.",
    "A song is swallowed by void.",
    "Empty promises float past.",
    "A dreamer awakens, alone.",
    "Stars shudder, unseen.",
    "Gravity twists into knots.",
    "Lost prayers flicker and die.",
    "The endless ocean of nothingness.",
    "A breeze of memories.",
    "Something ancient stirs.",
    "Silence thickens into substance.",
    "A glint of forgotten metal.",
    "The final sigh of a fallen titan.",
    "Dust dances where time decays.",
    "Invisible rivers of thought.",
    "Frozen echoes spiral downward.",
    "An infinite hush descends.",
    "Tears fall upward.",
    "The sky peels away its mask.",
    "Footprints in dark sand vanish.",
    "Faint pulses of old worlds.",
    "An unseen gate opens."
  ];

  function randomFromArray(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  async function sendMessage(text) {
    if (currentMessages.length >= 10) {
      let minTimeLeft = Infinity;
      let messageToDelete = null;
      const now = Date.now();
      currentMessages.forEach(msg => {
        const created = msg.data().created.toMillis();
        const timeLeft = 60 - (now - created) / 1000;
        if (timeLeft < minTimeLeft) {
          minTimeLeft = timeLeft;
          messageToDelete = msg;
        }
      });
      if (messageToDelete) {
        try {
          await deleteDoc(messageToDelete.ref);
        } catch (e) {
          console.error('Error deleting old message', e);
        }
      }
    }

    await addDoc(messagesRef, {
      text,
      created: serverTimestamp()
    });
  }

  document.getElementById('inputForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = document.getElementById('messageInput').value.trim();
    if (text) {
      await sendMessage(text);
      document.getElementById('messageInput').value = '';
    }
  });

  function updateHarvestDisplay() {
    document.getElementById('voidEnergy').textContent = voidEnergy;
    document.getElementById('voidLight').textContent = voidLight;
    document.getElementById('voidFractals').textContent = voidFractals;
  }

  onSnapshot(query(messagesRef, orderBy('created')), (snapshot) => {
    messagesDiv.innerHTML = '';
    const now = Date.now();
    currentMessages = snapshot.docs;

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      if (!data.created) return;

      const createdTime = data.created.toMillis();
      let elapsed = (now - createdTime) / 1000;
      let remaining = 60 - elapsed;

      if (remaining > 0) {
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `${data.text}`;

        const timerDiv = document.createElement('div');
        timerDiv.className = 'timer';
        timerDiv.innerText = `${Math.floor(remaining)}s`;
        div.appendChild(timerDiv);

        const moon = document.createElement('div');
        moon.className = 'moon-icon';
        moon.innerHTML = 'ðŸŒ‘';
        div.appendChild(moon);

        const repliesDiv = document.createElement('div');
        repliesDiv.className = 'replies';
        div.appendChild(repliesDiv);

        const expandButton = document.createElement('button');
        expandButton.className = 'expand-button';
        expandButton.innerText = 'Expand Replies';
        expandButton.style.display = 'none';
        div.appendChild(expandButton);

        expandButton.addEventListener('click', () => {
          repliesDiv.style.display = repliesDiv.style.display === 'none' ? 'flex' : 'none';
        });

        messagesDiv.appendChild(div);

        const interval = setInterval(async () => {
          remaining -= 1;
          if (remaining <= 0) {
            clearInterval(interval);
            try { await deleteDoc(docSnap.ref); } catch (e) {}
            div.remove();
          } else {
            timerDiv.innerText = `${Math.floor(remaining)}s`;
          }
        }, 1000);

        liveTimers[docSnap.id] = { interval, boost: () => { remaining += 5; timerDiv.innerText = `${Math.floor(remaining)}s`; } };

        div.addEventListener('click', (e) => {
          if (e.target !== moon && voidEnergy > 0) {
            voidEnergy -= 1;
            liveTimers[docSnap.id].boost();
            updateHarvestDisplay();
          }
        });

        moon.addEventListener('click', (e) => {
          e.stopPropagation();
          if (voidEnergy >= 10 || voidLight >= 1) {
            if (voidLight >= 1) {
              voidLight -= 1;
            } else {
              voidEnergy -= 10;
            }
            updateHarvestDisplay();
            const replyText = prompt("Whisper back to the void:");
            if (replyText) {
              const replyDiv = document.createElement('div');
              replyDiv.className = 'reply';
              replyDiv.textContent = replyText;
              repliesDiv.appendChild(replyDiv);
              expandButton.style.display = 'inline-block';
            }
          } else {
            alert("Not enough Void Energy or Void Light to reply.");
          }
        });
      }
    });
  });

  // -------- Auto Message Spawner --------
  function createAutoMessage(type) {
    const div = document.createElement('div');
    div.className = 'message auto-message';

    let points = 0;
    if (type === 'blue') {
      div.style.backgroundColor = 'rgba(173, 216, 230, 0.2)';
      div.textContent = randomFromArray(autoMessages);
      points = Math.floor(Math.random() * 13) + 3; // 3-15
    } else if (type === 'orange') {
      div.style.backgroundColor = 'rgba(255, 165, 0, 0.3)';
      div.textContent = "The void stirs more deeply...";
      points = Math.floor(Math.random() * 5) + 1; // 1-5
    } else if (type === 'red') {
      div.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
      div.textContent = "A void fractal emerges...";
      points = 1;
    }

    div.addEventListener('click', () => {
      if (type === 'blue') voidEnergy += points;
      if (type === 'orange') voidLight += points;
      if (type === 'red') voidFractals += points;
      updateHarvestDisplay();
      div.remove();
    });

    messagesDiv.appendChild(div);

    setTimeout(() => {
      div.remove();
    }, type === 'red' ? 10000 : 5000);
  }

  setInterval(() => {
    createAutoMessage('blue');
  }, Math.random() * 15000 + 15000);

  setInterval(() => {
    createAutoMessage('orange');
  }, 10 * 60 * 1000);

  setInterval(() => {
    createAutoMessage('red');
  }, Math.random() * 1800000 + 1800000);

</script>

</body>
</html>
